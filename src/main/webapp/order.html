<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order Management</title>
<style>
    body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 0;
        color: #333;
    }

    h1 {
        text-align: center;
        padding: 20px 0;
        background: #2f3640;
        color: #fff;
        margin: 0;
        letter-spacing: 1px;
    }

    .container {
        width: 95%;
        max-width: 1300px;
        margin: 30px auto;
        background: #fff;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
    }

    th {
        background-color: #2f3640;
        color: white;
        padding: 12px;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    td {
        padding: 10px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
        text-align: center;
    }

    tr:hover {
        background-color: #f1f3f6;
    }

    select, input[type="date"], input[type="time"] {
        padding: 5px 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        outline: none;
        font-size: 13px;
        background: #fff;
        transition: 0.2s;
    }

    select:focus, input:focus {
        border-color: #007bff;
        box-shadow: 0 0 4px rgba(0,123,255,0.3);
    }

    button {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        color: white;
        font-size: 13px;
        transition: all 0.2s ease;
    }

    button:hover {
        transform: scale(1.05);
    }

    button:nth-child(1) {
        background-color: #007bff;
    }

    button:nth-child(1):hover {
        background-color: #0069d9;
    }

    button:nth-child(2) {
        background-color: #dc3545;
    }

    button:nth-child(2):hover {
        background-color: #c82333;
    }

    .footer {
        text-align: center;
        margin-top: 30px;
        color: #666;
        font-size: 13px;
    }
</style>
</head>
<body>
    <h1>Order Management</h1>

    <div class="container">
        <table id="orderTable">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Cargo</th>
                    <th>Loading City</th>
                    <th>Loading Date</th>
                    <th>Loading Time</th>
                    <th>Unloading City</th>
                    <th>Unloading Date</th>
                    <th>Unloading Time</th>
                    <th>Driver</th>
                    <th>Truck</th>
                    <th>Carrier</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="footer">
        Â© 2025 ABC Logistics | Admin Panel
    </div>

<script>
const backend = "http://localhost:8080/admin";
let drivers = [];

async function loadDrivers() {
    const res = await fetch(`${backend}/getAllDrivers`);
    const data = await res.json();
    drivers = data.data || [];
}

async function loadOrders() {
    const res = await fetch(`${backend}/getAllOrders`);
    const data = await res.json();
    const orders = data.data || [];
    const tbody = document.querySelector("#orderTable tbody");
    tbody.innerHTML = "";

    orders.forEach(order => {
        const driverId = order.driver ? order.driver.id : '';
        const loadDate = order.loading?.date || '';
        const loadTime = order.loading?.time || '';
        const unloadDate = order.unloading?.date || '';
        const unloadTime = order.unloading?.time || '';

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${order.id}</td>
            <td>${order.cargo?.name || ''}</td>
            <td>${order.loading?.address?.city || ''}</td>
            <td><input type="date" id="loadDate-${order.id}" value="${loadDate}"></td>
            <td><input type="time" id="loadTime-${order.id}" value="${loadTime}"></td>
            <td>${order.unloading?.address?.city || ''}</td>
            <td><input type="date" id="unloadDate-${order.id}" value="${unloadDate}"></td>
            <td><input type="time" id="unloadTime-${order.id}" value="${unloadTime}"></td>
            <td>
                <select id="driver-${order.id}">
                    <option value="">Select Driver</option>
                    ${drivers.map(d => 
                        `<option value="${d.id}" ${d.id == driverId ? 'selected' : ''}>${d.name}</option>`
                    ).join('')}
                </select>
            </td>
            <td>${order.driver?.truck?.number || ''}</td>
            <td>${order.carrier?.name || ''}</td>
            <td>${order.cost}</td>
            <td>${order.status}</td>
            <td>
                <button onclick="updateOrder(${order.id})">Update</button>
                <button onclick="deleteOrder(${order.id})">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function updateOrder(orderId) {
    const driverId = document.querySelector(`#driver-${orderId}`).value;
    const loadDate = document.querySelector(`#loadDate-${orderId}`).value;
    const loadTime = document.querySelector(`#loadTime-${orderId}`).value;
    const unloadDate = document.querySelector(`#unloadDate-${orderId}`).value;
    const unloadTime = document.querySelector(`#unloadTime-${orderId}`).value;

    try {
        if (driverId) {
            await fetch(`${backend}/updateorder/${orderId}/assigndriver/${driverId}`);
        }
        if (loadDate && loadTime) {
            await fetch(`${backend}/updateorder/${orderId}/updateloading`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: loadDate, time: loadTime })
            });
        }
        if (unloadDate && unloadTime) {
            await fetch(`${backend}/updateorder/${orderId}/updateUnloading`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date: unloadDate, time: unloadTime })
            });
        }

        alert("Order updated successfully!");
        loadOrders();

    } catch (err) {
        console.error(err);
        alert("Failed to update order");
    }
}

async function deleteOrder(orderId) {
    if (!confirm("Are you sure you want to delete this order?")) return;
    const res = await fetch(`${backend}/deleteorder/${orderId}`, { method: 'DELETE' });
    if (res.ok) {
        alert("Order deleted successfully");
        loadOrders();
    } else {
        alert("Failed to delete order");
    }
}

(async function init() {
    await loadDrivers();
    await loadOrders();
})();
</script>
</body>
</html>
